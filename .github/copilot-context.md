# CANopen XMC4800 å°ˆæ¡ˆä»£ç¢¼ä¸Šä¸‹æ–‡

é€™å€‹å°ˆæ¡ˆå¯¦ç¾äº†åœ¨ XMC4800 å¾®æ§åˆ¶å™¨ä¸Šçš„ CANopen å”è­°æ£§ã€‚ä»¥ä¸‹æ˜¯é‡è¦çš„å°ˆæ¡ˆèƒŒæ™¯è³‡è¨Šï¼š

## ğŸ¯ å°ˆæ¡ˆç›®æ¨™
å°‡ CANopenNode é–‹æºå”è­°æ£§ç§»æ¤åˆ° XMC4800ï¼Œè§£æ±ºåŸæœ¬ "CANopen API æ ¹æœ¬ç„¡æ³•æ­£å¸¸å·¥ä½œ" çš„å•é¡Œã€‚

## ğŸ”§ é—œéµæŠ€è¡“æ±ºç­–

### æ··åˆå¼ç¡¬é«”æŠ½è±¡å±¤
ç”±æ–¼ DAVE 4.5.0 API é™åˆ¶ï¼Œæ¡ç”¨ã€Œç›´æ¥ç¡¬é«”æš«å­˜å™¨ + DAVE APIã€çš„æ··åˆæ–¹æ³•ï¼š

```c
// è¨­å®š CAN ID - ç›´æ¥æ“ä½œç¡¬é«”æš«å­˜å™¨
mo->can_mo_ptr->MOAR = (buffer->ident & 0x7FF) << CAN_MO_MOAR_ID_Pos;

// è¨­å®šæ•¸æ“š - ä½¿ç”¨ DAVE API
CAN_NODE_MO_UpdateData(lmo, buffer->data);
```

### è¨ˆæ™‚å™¨æ•´åˆç­–ç•¥
CANopen éœ€è¦ç²¾ç¢ºçš„ 1ms è¨ˆæ™‚ï¼Œä½¿ç”¨ SYSTIMER ä¸­æ–·ï¼š

```c
volatile uint32_t CO_timer1ms = 0;

void SYSTIMER_Callback(void) {
    CO_timer1ms++;  // CANopen æ ¸å¿ƒè¨ˆæ™‚å™¨
}
```

## ğŸ“‹ æ ¸å¿ƒå‡½æ•¸å¯¦ç¾ç‹€æ…‹

### âœ… å·²å®Œæˆ
- `CO_CANsend()`: CAN å‚³é€åŠŸèƒ½ï¼Œä½¿ç”¨æ··åˆå¼ API
- `CO_CANinterrupt_Rx()`: CAN æ¥æ”¶ä¸­æ–·è™•ç†
- `Debug_Printf()`: UART é™¤éŒ¯è¼¸å‡º
- `mainTask_1ms()`: ä¸»ä»»å‹™å¾ªç’°

### ğŸ”„ éƒ¨åˆ†å®Œæˆ
- CANopen æ¨™æº–è¨Šæ¯å‚³è¼¸ (æ¸¬è©¦ä¸­)
- éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶ (åŸºç¤ç‰ˆæœ¬)
- NMT ç‹€æ…‹ç®¡ç† (æ ¸å¿ƒåŠŸèƒ½å¯ç”¨)

### âŒ å¾…å¯¦ç¾
- å®Œæ•´çš„ SDO æœå‹™
- LSS (Layer Setting Services)
- éæ®ç™¼æ€§å­˜å„²

## ğŸ› å·²çŸ¥å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### DAVE API ä¸å­˜åœ¨å•é¡Œ
```c
// âŒ é€™å€‹å‡½æ•¸ä¸å­˜åœ¨
CAN_NODE_MO_UpdateID();

// âœ… ä½¿ç”¨æ­¤è§£æ±ºæ–¹æ¡ˆ
mo->can_mo_ptr->MOAR = (mo->can_mo_ptr->MOAR & ~CAN_MO_MOAR_ID_Msk) | 
                      ((buffer->ident & 0x7FF) << CAN_MO_MOAR_ID_Pos);
```

### UART ç·©è¡å€é™åˆ¶
- æœ€å¤§ 256 å­—ç¯€ï¼Œé¿å…é•·å­—ä¸²è¼¸å‡º
- ç°¡åŒ–é™¤éŒ¯è¨Šæ¯æ ¼å¼
- é¿å…åœ¨ä¸­æ–·ä¸­é•·æ™‚é–“ UART å‚³è¼¸

## ğŸ“Š æ¸¬è©¦é©—è­‰æ–¹æ³•

### CAN å‚³è¼¸æ¸¬è©¦
- ä½¿ç”¨ CAN åˆ†æå„€ç›£æ§ ID=0x123 æ¸¬è©¦è¨Šæ¯
- æª¢æŸ¥ CANopen æ¨™æº– ID ç¯„åœ (0x080-0x7FF)
- é©—è­‰ UART è¼¸å‡º: "TX: ID=0x123 DLC=8"

### å”è­°æ¨™æº–æ¸¬è©¦
- Emergency: 0x080 + Node ID
- TPDO: 0x180 + Node ID
- Heartbeat: 0x700 + Node ID

## ğŸ”„ èˆ‡ CANopenSTM32 å°ç…§
æ­¤å°ˆæ¡ˆåƒè€ƒ CANopenSTM32 çš„æ¨™æº–å¯¦ç¾æ¨¡å¼ï¼Œä¸»è¦å·®ç•°ï¼š
- STM32 HAL â†’ XMC4800 DAVE
- HAL_TIM â†’ SYSTIMER
- æ¨™æº–å›èª¿ â†’ DAVE ä¸­æ–·è™•ç†

## ğŸ’¡ ç·¨ç¨‹æç¤º

## ğŸ’¡ ç·¨ç¨‹æç¤º

### å°ˆæ¥­å·¥ç¨‹å¸«é–‹ç™¼åŸå‰‡
- **ä¸ç°¡åŒ–å·¥ä½œ**: ç¶­æŒå®Œæ•´çš„å·¥ç¨‹å¯¦ç¾ï¼Œä¸èµ°æ·å¾‘
- **ä¸ç°¡åŒ–ç¨‹å¼ç¢¼**: ä¿æŒä»£ç¢¼çš„å®Œæ•´æ€§å’Œå¯è®€æ€§
- **æ·±åº¦ç†è§£**: å°ˆæ¡ˆä»£ç¢¼ç¸½é‡ä¸åˆ° 1000 è¡Œï¼Œå¿…é ˆå®Œå…¨æŒæ¡æ¯å€‹å‡½æ•¸
- **ç³»çµ±æ€ç¶­**: ä»¥è³‡æ·±å·¥ç¨‹å¸«çš„å°ˆæ¥­ç²¾ç¥åˆ†æå’Œè§£æ±ºå•é¡Œ

### é–‹ç™¼ç´„æŸæ¢ä»¶
- **å›ºå®šå·¥å…·éˆ**: åªä½¿ç”¨ DAVE IDE 4.5.0 + ARM-GCC-49
- **å›ºå®šç·¨è­¯è·¯å¾‘**: `C:\prj\AI\CANOpen\Dave\XMC4800_CANopen\Debug`
- **å›ºå®šç‡’éŒ„è…³æœ¬**: ä½¿ç”¨æ—¢æœ‰çš„ `flash_canopen.jlink`
- **ç¦æ­¢æ–°å¢æª”æ¡ˆ**: ä¸æ–°å¢ .c æª”ã€batch æª”æˆ– J-Link è…³æœ¬

### ä¿®æ”¹ç¡¬é«”ç›¸é—œä»£ç¢¼æ™‚
1. æ‰€æœ‰ CAN ç›¸é—œä¿®æ”¹åœ¨ `CO_driver_XMC4800.c`
2. ä¸è¦ä¿®æ”¹ `Dave/Generated/` ç›®éŒ„
3. ä½¿ç”¨æ··åˆå¼ API æ–¹æ³•
4. æ·»åŠ è©³ç´°çš„ UART é™¤éŒ¯è¼¸å‡º

### é™¤éŒ¯æŠ€å·§
1. åˆ†æ®µæ¸¬è©¦ï¼šDAVE_Init â†’ UART â†’ CAN â†’ CANopen
2. ç›£æ§é—œéµè®Šæ•¸ï¼š`CO_timer1ms`, `errCnt_CO_init`
3. ä½¿ç”¨ CAN åˆ†æå„€é©—è­‰å¯¦éš›å‚³è¼¸

### ä»£ç¢¼é¢¨æ ¼
- å‡½æ•¸å‘½åï¼š`function_name()`
- è®Šæ•¸å‘½åï¼š`variable_name`
- å¸¸æ•¸ï¼š`CONSTANT_NAME`
- è¨»è§£ï¼šä¸­æ–‡èªªæ˜ï¼Œè‹±æ–‡ä»£ç¢¼